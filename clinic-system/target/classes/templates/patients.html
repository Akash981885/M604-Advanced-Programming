<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Patients</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- ===== Inline CSS ===== -->
    <style>
        :root{
          --bg:#0f172a; --panel:#111827; --card:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
          --accent:#22c55e; --accent-dark:#16a34a; --danger:#ef4444; --blue:#3b82f6;
          --border:#374151; --shadow:0 10px 25px rgba(0,0,0,.35),0 4px 10px rgba(0,0,0,.2);
          --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;padding:32px 18px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
        .container{max-width:1100px;margin:auto}
        .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
        .title{font-size:28px;font-weight:800}
        .nav a{color:var(--muted);margin-left:16px;text-decoration:none;font-weight:600}
        .nav a:hover{color:var(--text)}
        .grid{display:grid;grid-template-columns:1.6fr .9fr;gap:18px}
        @media(max-width:980px){.grid{grid-template-columns:1fr}}
        .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
        table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);background:rgba(31,41,55,.6);border-radius:12px;overflow:hidden}
        thead th{padding:12px;background:rgba(55,65,81,.6);color:var(--muted)}
        tbody td{padding:12px;border-bottom:1px solid var(--border)}
        tbody tr:hover{background:rgba(55,65,81,.25)}
        .btn{border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px}
        .btn-edit{background:var(--blue);color:#fff}
        .btn-delete{background:var(--danger);color:#fff}
        .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#001a09}
        .btn-secondary{background:rgba(156,163,175,.15);color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{background:rgba(156,163,175,.25)}
        .actions{margin-top:14px;display:flex;gap:10px}
        input,select{width:100%;padding:10px;border-radius:10px;background:var(--panel);color:var(--text);border:1px solid var(--border)}
        input:focus{border-color:var(--accent);outline:none}
        .status{font-size:13px;color:var(--muted);min-height:18px}
        .status.ok{color:#86efac}
        .status.err{color:#fca5a5}

        /* ===== Modal ===== */
        #editModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
        #editModal .modal-content{background:var(--card);padding:20px;border-radius:14px;width:350px;box-shadow:var(--shadow)}
        #editModal h3{margin-top:0}
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <div class="title">Patients</div>
        <div class="nav">
            <a href="/">Home</a>
            <a href="/doctors">Doctors</a>
            <a href="/appointments">Appointments</a>
            <a href="/swagger-ui.html">API Docs</a>
        </div>
    </div>

    <div class="grid">

        <!-- ===== Patient List with Edit/Delete ===== -->
        <section class="card">
            <h2>Patient List</h2>
            <div style="overflow:auto">
                <table id="patientsTable">
                    <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${patients}">
                        <td th:text="${p.id}"></td>
                        <td th:text="${p.firstName + ' ' + p.lastName}"></td>
                        <td th:text="${p.email}"></td>
                        <td th:text="${p.phone}"></td>
                        <td>
                            <button class="btn btn-edit" th:onclick="'openEditModal(' + ${p.id} + ')'">Edit</button>
                            <button class="btn btn-delete" th:onclick="'deletePatient(' + ${p.id} + ')'">Delete</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ===== Add Patient Form ===== -->
        <section class="card">
            <h2>Add New Patient</h2>
            <form id="addPatientForm" autocomplete="off">
                <label for="firstName">First Name</label>
                <input id="firstName" required>
                <label for="lastName">Last Name</label>
                <input id="lastName" required>
                <label for="email">Email</label>
                <input id="email" type="email" required>
                <label for="phone">Phone</label>
                <input id="phone">
                <label for="dob">Date of Birth</label>
                <input id="dob" type="date">
                <label for="gender">Gender</label>
                <input id="gender">
                <label for="address">Address</label>
                <input id="address">
                <div class="actions">
                    <button class="btn btn-primary" type="submit">Add</button>
                    <span id="statusMsg" class="status" aria-live="polite"></span>
                </div>
            </form>
        </section>

    </div>
</div>

<!-- ===== EDIT MODAL ===== -->
<div id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
        <h3 id="editTitle">Edit Patient</h3>
        <label for="editFirstName">First Name</label>
        <input id="editFirstName">
        <label for="editLastName">Last Name</label>
        <input id="editLastName">
        <label for="editEmail">Email</label>
        <input id="editEmail" type="email">
        <label for="editPhone">Phone</label>
        <input id="editPhone">
        <label for="editDob">Date of Birth</label>
        <input id="editDob" type="date">
        <label for="editGender">Gender</label>
        <input id="editGender">
        <label for="editAddress">Address</label>
        <input id="editAddress">
        <div class="actions">
            <button class="btn btn-primary" onclick="updatePatient()">Update</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
        <span id="editStatus" class="status"></span>
    </div>
</div>

<!-- ===== Inline Script (FIXED) ===== -->
<script>
    (() => {
      let editingId = null;

      const $ = (id) => document.getElementById(id);
      const toDateInput = (s) => (s ? String(s).substring(0,10) : '');

      // Open Edit Modal
      window.openEditModal = async function(id){
        editingId = id;
        try{
          const res = await fetch(`/api/patients/${id}`);
          if(!res.ok) throw new Error(await res.text());
          const p = await res.json();

          $('editFirstName').value = p.firstName ?? '';
          $('editLastName').value  = p.lastName ?? '';
          $('editEmail').value     = p.email ?? '';
          $('editPhone').value     = p.phone ?? '';
          $('editDob').value       = toDateInput(p.dob);
          $('editGender').value    = p.gender ?? '';
          $('editAddress').value   = p.address ?? '';

          $('editModal').style.display = 'flex';
        }catch(err){
          alert('Failed to load patient: ' + (err.message || ''));
        }
      };

      // Close modal
      window.closeModal = function(){
        $('editModal').style.display = 'none';
        editingId = null;
      };

      // Update Patient
      window.updatePatient = async function(){
        if(!editingId){ alert('No patient selected.'); return; }

        const payload = {
          firstName: $('editFirstName').value.trim(),
          lastName:  $('editLastName').value.trim(),
          email:     $('editEmail').value.trim(),
          phone:     $('editPhone').value.trim() || null,
          dob:       $('editDob').value || null,
          gender:    $('editGender').value.trim() || null,
          address:   $('editAddress').value.trim() || null
        };

        try{
          const res = await fetch(`/api/patients/${editingId}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error(await res.text());
          location.reload();
        }catch(err){
          alert('Failed to update: ' + (err.message || ''));
        }
      };

      // Delete Patient
      window.deletePatient = async function(id){
        if(!confirm('Delete this patient?')) return;
        try{
          const res = await fetch(`/api/patients/${id}`, { method:'DELETE' });
          if(!res.ok) throw new Error(await res.text());
          location.reload();
        }catch(err){
          alert('Failed to delete: ' + (err.message || ''));
        }
      };

      // Create patient
      document.addEventListener('DOMContentLoaded', () => {
        const addForm = $('addPatientForm');
        if(!addForm) return;

        addForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const payload = {
            firstName: $('firstName').value.trim(),
            lastName:  $('lastName').value.trim(),
            email:     $('email').value.trim(),
            phone:     $('phone').value.trim() || null,
            dob:       $('dob').value || null,
            gender:    $('gender').value.trim() || null,
            address:   $('address').value.trim() || null
          };

          try{
            const res = await fetch('/api/patients', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            if(!res.ok) throw new Error(await res.text());
            location.reload();
          }catch(err){
            alert('Failed to add patient: ' + (err.message || ''));
          }
        });
      });
    })();
</script>

</body>
</html>
